import MD5 from"../utils/md5";const polyvVodPlayer={version:"v1.0.0",buidMetaData:20190221,options:null,jsonHost:"https://router.polyv.net/proxy/player.polyv.net/secure/",isPreviewMode:!1,isWx:!1,token:"",seed:0,state:"end",timeStamp:0,time:0,currentTime:0,detailTime:0,videoId:"",pid:"",uid:"",flow:0,pd:0,sd:0,cts:0,duration:0,pn:"",pv:"",sign:"",sessionId:"",param1:"",param2:"",param3:"",param4:"",param5:"",getVideo(t){this.loadJson(t)},getPreviewVideo(t){this.isPreviewMode=!0,this.loadJson(t)},changeVid(t){const e=t.vid,a=t.changeVidcallback;e&&e.length>0&&e!==this.videoId&&(this.videoId=e,this.getVideoJson().then(t=>{a(t)}).catch())},loadJson(t){const e=this.version;let a={version:e,timeoutflow:!1,outflow:!1};if(!t.vid)return a={version:e,error:"vid不能为空"},void t.callback(a);const r=`${(new Date).getTime()}X${Math.floor(1e6*Math.random()+1e6)}`,s=t.vid.substr(0,10),i=this;i.videoId=t.vid,i.ts=t.ts,i.sign=t.sign,i.uid=s,i.pid=r,i.version=a.version,i.param1=t.param1||"",i.param2=t.param2||"",i.param3=t.param3||"",i.param4=t.param4||"",i.param5=t.param5||"",t.sid&&(i.sessionId=t.sid),i.options=t,wx.request({url:`${i.jsonHost+t.vid}.js`,method:"GET",success(e){"true"===e.data.timeoutflow?a.timeoutflow=!0:"true"===e.data.outflow?a.outflow=!0:(a.poster=e.data.first_image,a.title=e.data.title,a.teaser_url=e.data.teaser_url,a.catatree=e.data.catatree,a.adMatter=e.data.adMatter,a.ratio=e.data.ratio,a.duration=e.data.duration,a.poster=i.proxy(a.poster),a.teaser_url=i.proxy(a.teaser_url),a.adMatter=i.proxy(a.adMatter,"matterurl"),i.seed=e.data.seed,1===e.data.seed?a.src=i.proxy(e.data.hls):a.src=i.proxy(e.data.mp4),i.duration=e.data.duration),1===i.seed&&t.wxApp&&t.wxApp.isWx?(i.isWx=!0,i.getWxToken(t,r=>{i.token=r;for(let r=0;r<e.data.hls.length;r++)t.hlstest?a.src[r]=i.resetUrl(e.data.hls[r]).replace("hls.","hlstest."):a.src[r]=i.resetUrl(e.data.hls[r]);t.callback(a)},()=>{a={error:"播放token获取失败"},t.callback(a)})):t.callback(a),i.countInterval&&clearInterval(i.countInterval),i.countInterval=setInterval(()=>{i.countWholeTime()},1e3)},fail(e){a={error:"视频数据获取失败"},t.callback(a)}})},getVideoJson(){const t=this;return new Promise((e,a)=>{wx.request({url:`${t.jsonHost}${t.videoId}.js`,method:"GET",success(a){let r={};"true"===a.data.timeoutflow?(r.timeoutflow=!0,r.canplay=0):"true"===a.data.outflow?(r.outflow=!0,r.canplay=1):(r.poster=a.data.first_image,r.title=a.data.title,r.teaser_url=a.data.teaser_url,r.catatree=a.data.catatree,r.adMatter=a.data.adMatter,r.ratio=a.data.ratio,r.duration=a.data.duration,r.poster=t.proxy(r.poster),r.teaser_url=t.proxy(r.teaser_url),r.adMatter=t.proxy(r.adMatter,"matterurl"),t.seed=a.data.seed,1===a.data.seed?r.src=t.proxy(a.data.hls):r.src=t.proxy(a.data.mp4),t.duration=a.data.duration),e(r)},fail(){a()}})})},getWxToken(t,e){const a=t.wxApp.wxAppUrl,r=(new Date).getTime(),s=CModule.ccall("getsign","string",["string","string","string"],[t.wxApp.wxUserId,t.vid,r.toString()]),i=t.wxApp;i.iswxa=1,i.vid=t.vid,i.ts=r,i.sign=s,wx.request({url:a,method:"GET",data:i,success(t){const a=CModule.ccall("loadtoken","string",["string"],[t.data]);e(JSON.parse(a).data.token)},fail(){}})},timeUpdate(t){t&&t.detail&&t.detail.currentTime&&(this.detailTime=t.detail.currentTime)},updateState(){this.currentTime==this.detailTime?this.state="end":(this.state="played",this.currentTime=this.detailTime)},countWholeTime(){const t=this,e=(new Date).getTime();t.updateState(),"played"==this.state&&(t.time+=1),e-t.timeStamp>9e3&&(t.timeStamp=e,t.sendState())},sendState(){const t=this;let e=0,a=0;if(a=Math.floor(this.currentTime),(e=t.time)>0&&"played"==t.state){(new Date).getTime();const s=`rtas.net${t.pid}${t.videoId}${t.flow}${e}${a}`,i=MD5(s),o=t.sessionId;var r={pid:t.pid,uid:t.uid,vid:t.videoId,flow:0,pd:e,sd:e,cts:a,duration:t.duration,pn:"webapp_vod_sdk",pv:t.version,sign:i,sid:o,param1:t.param1,param2:t.param2,param3:t.param3,param4:t.param4,param5:t.param5};wx.request({url:"https://router.polyv.net/proxy/prtas.videocc.net/v1/view",data:r})}},proxy(t,e){const a=this;if(void 0===t||0==t.length)return"";if("string"==typeof t)return t=this.resetUrl(t),this.proxyUrl(t);if(arguments[1])for(var r=0,s=t.length;r<s;r++)for(const a in t[r])a==e&&(t[r][a]=this.proxyUrl(t[r][a]));else for(r=0,s=t.length;r<s;r++){if(this.isPreviewMode){const e=this.videoId.substring(0,32);t[r]=t[r].replace(e,`p_${e}`)}a.ts&&a.sign&&(t[r].indexOf("?")>-1?t[r]=`${t[r]}&ts=${a.ts}&sign=${a.sign}`:t[r]=`${t[r]}?ts=${a.ts}&sign=${a.sign}`),t[r]=this.proxyUrl(t[r])}return t},proxyUrl:t=>""==t?t:`https://router.polyv.net/proxy/${t=t.replace(/.*?:\/\//g,"")}`,resetUrl(t){const e=this;if(this.isPreviewMode&&1==e.seed){const e=this.videoId.substring(0,32);t=t.replace(e,`p_${e}`)}return e.ts&&e.sign&&(t=t.indexOf("?")>-1?`${t}&ts=${e.ts}&sign=${e.sign}`:`${t}?ts=${e.ts}&sign=${e.sign}`),e.isWx&&(t=t.indexOf("?")>-1?`${t}&token=${e.token}&iswxa=1`+`&pid=${e.pid}`:`${t}?token=${e.token}&iswxa=1`+`&pid=${e.pid}`),t}};export default polyvVodPlayer;