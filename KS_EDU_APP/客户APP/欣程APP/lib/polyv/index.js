import regeneratorRuntime from"./common/regenerator-runtime/runtime-module";import Chat from"./common/chat/chat";import store from"./store/index";import api from"./common/api/index";import util from"./common/utils/utils";let chat;const checkParams=(t,e)=>{for(let a=0,o=e.length;a<o;a++){const o=e[a];if(o.indexOf("|")>-1){const e=o.split("|");if(Object.keys(t).find(t=>t===e[0]||t===e[1]))return}if(void 0===t[o])throw new Error(`缺少参数${o}`)}};function initChat(){const{userName:t,channelId:e,avatarUrl:a,channelDetail:o}=store.get("main"),{userId:r}=store.get("app"),n={userId:r,userName:t,roomName:e,pic:a,userType:o.isPPT?"slice":"student"};return chatClose(),(chat=new Chat({...n,micUserId:n.userId})).setup(),store.set({"main.chat":chat}),chat}function chatClose(){chat&&(chat.disconnectSocket(),chat=null)}const destory=()=>{chatClose(),store.reset()},logVersion=()=>{console.log("VERSION: 1.1.0")};function setApp(t){if(logVersion(),"object"!=typeof t)throw Error("请传入正确格式参数");checkParams(t,["apiId","apiSecret|verifyUrl"]),store.set("app",t)}const _dealDetail=async t=>{const e="Y"===t.playbackEnabled&&t.hasPlayback;t.isPPT="ppt"===t.scene;try{if(e){const{data:e}=await api.getPlayBackVideos({channelId:t.channelId});if(200!==e.code)throw e;t.playbackList=e.data.contents}}catch(t){console.error(t)}return t},_getPolyvUserId=t=>new Promise((e,a)=>{const o=store.get("main.openId"),r=store.get("app.userId");t===o&&r?e({data:r}):api.getUserId(t).then(t=>{200!==t.data.code&&a(t),e(t.data)})}),_requestDetail=t=>api.getChannelDetail(t).then(t=>{if(200!==t.data.code)throw t;return t.data});function init(t){return new Promise((e,a)=>{util.isObj(t)||a(Error("options must be object!")),checkParams(t,["openId","channelId","userName","avatarUrl"]),t&&t.pptDelayTime||(t.pptDelayTime=3e3),store.set("main",{...t}),store.set({"main.userInfo":{...t}});const{openId:o,channelId:r,immediateChat:n=!0}=t;Promise.all([_getPolyvUserId(o),_requestDetail(r)]).then(async a=>{const[o,r]=a,i=o.data,s=await _dealDetail(r.data);s.useVideo=t.useVideo||!1,store.set({"app.userId":i,"main.channelDetail":s}),n&&initChat(),e({detail:s,chat:chat})}).catch(t=>{"[object Object]"===Object.prototype.toString.call(t)&&a(t.data),a(t)})})}export default{setApp:setApp,init:init,destory:destory,initChat:initChat,api:api};